sap.ui.define([                                                                                                                                                                                                                                                
    "sap/m/MessageToast"                                                                                                                                                                                                                                       
], function (MessageToast) {                                                                                                                                                                                                                                   
    'use strict';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return {                                                                                                                                                                                                                                                   
        onBeforeRendering: function () {                                                                                                                                                                                                                       
            this.getView().byId(this.byId("Carga_ExelButton").getId()).setIcon("sap-icon://upload");                                                                                                                                                           
        },                                                                                                                                                                                                                                                     
        Carga_Exel: function (oEvent) {                                                                                                                                                                                                                        
            /* ===================================================================                                                                                                                                                                             
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
            var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                             
                contentWidth: "400px",                                                                                                                                                                                                                         
                resizable: true                                                                                                                                                                                                                                
            });                                                                                                                                                                                                                                                
            oUploadDialog.setTitle("Carregar arquivo Excel");                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
            Define o serviço gateway que será chamado                                                                                                                                                                                                          
            =================================================================== */                                                                                                                                                                             
            var sServiceUrl = "/sap/opu/odata/sap/ZMM_ARVORE_MERCADOLOGICA_SRV/";                                                                                                                                                                              
            var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, false);                                                                                                                                                                                
            var sSource = sServiceUrl + "CargaArvoreMercSet";                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
            Prepara o responsável pela carga do arquivo                                                                                                                                                                                                        
            =================================================================== */                                                                                                                                                                             
            var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                              
                width: "100%",                                                                                                                                                                                                                                 
                fileType: ['csv'],                                                                                                                                                                                                                             
                typeMissmatch: this.handleTypeMissmatch,                                                                                                                                                                                                       
                uploadComplete: function (oEvent) {                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    // Atualiza tabela do relatório após carga                                                                                                                                                                                                 
                    var sId = this.oView.sId + '--responsiveTable';                                                                                                                                                                                            
                    var oTable = this.byId(sId);                                                                                                                                                                                                               
                    oTable.getModel().refresh(true);                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    oUploadDialog.close();                                                                                                                                                                                                                     
                    oUploadDialog.destroy();                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    // Verifica o retorno da mensagem                                                                                                                                                                                                          
                    if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                                  
                        oEvent.mParameters.status == '201') {                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                    else {                                                                                                                                                                                                                                     
                        if (oEvent.mParameters.response) {                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                            alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                                      
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
           Define parâmetros                                                                                                                                                                                                                                   
            =================================================================== */                                                                                                                                                                             
            oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                          
            oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                               
            oFileUploader.setSendXHR(true);                                                                                                                                                                                                                    
            oFileUploader.setUseMultipart(false);                                                                                                                                                                                                              
            oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                            
                name: "x-csrf-token",                                                                                                                                                                                                                          
                value: oModel.getSecurityToken()                                                                                                                                                                                                               
            });                                                                                                                                                                                                                                                
            oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
            Cria botão para a carga do arquivo                                                                                                                                                                                                                 
            =================================================================== */                                                                                                                                                                             
            var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                            
                text: 'Upload',                                                                                                                                                                                                                                
                type: 'Accept',                                                                                                                                                                                                                                
                press: function () {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    // Verifica se arquivo foi informado                                                                                                                                                                                                       
                    var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                               
                    var file = domRef.files[0];                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    if (oFileUploader.getValue() === '') {                                                                                                                                                                                                     
                        sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                                
                        return;                                                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                              
                        name: "Content-Type",                                                                                                                                                                                                                  
                        value: file.type                                                                                                                                                                                                                       
                    });                                                                                                                                                                                                                                        
                    oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    // Recupera o tipo de arquivo: C - Curto, M - Médio                                                                                                                                                                                        
                    //var vType = oTriggerRadioButton.getSelectedButton().mProperties.text[0];                                                                                                                                                                 
                    oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                             
                        name: "SLUG",                                                                                                                                                                                                                          
                        value: oFileUploader.getValue() // + ";" + vType                                                                                                                                                                                       
                    }));                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    oFileUploader.upload();                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
            Cria botão de cancelar                                                                                                                                                                                                                             
            =================================================================== */                                                                                                                                                                             
            var oCancelButton = new sap.m.Button({                                                                                                                                                                                                             
                text: 'Cancelar',                                                                                                                                                                                                                              
                type: 'Reject',                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                press: function () {                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    oUploadDialog.close();                                                                                                                                                                                                                     
                    oUploadDialog.destroy();                                                                                                                                                                                                                   
                    this.getView().removeAllDependents();                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            /* ===================================================================                                                                                                                                                                             
            Cria radio-button                                                                                                                                                                                                                                  
            =================================================================== */                                                                                                                                                                             
            // var oTriggerRadioButton = new sap.m.RadioButtonGroup({                                                                                                                                                                                          
            //     columns: 2,                                                                                                                                                                                                                                 
            //     width: "100%",                                                                                                                                                                                                                              
            //     buttons: [                                                                                                                                                                                                                                  
            //         new sap.m.RadioButton({                                                                                                                                                                                                                 
            //             text: "Curto Prazo"                                                                                                                                                                                                                 
            //         }),                                                                                                                                                                                                                                     
            //         new sap.m.RadioButton({                                                                                                                                                                                                                 
            //             text: "Médio Prazo"                                                                                                                                                                                                                 
            //         })],                                                                                                                                                                                                                                    
            // });                                                                                                                                                                                                                                             
            /* ===================================================================                                                                                                                                                                             
            Chama diálogo com a lógica de carga                                                                                                                                                                                                                
            =================================================================== */                                                                                                                                                                             
            oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                           
            // oUploadDialog.addContent(oTriggerRadioButton);                                                                                                                                                                                                  
            oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                       
            oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                        
            oUploadDialog.open();                                                                                                                                                                                                                              
            // let oFilter = this.getView().byId("listReportFilter").getFilters();                                                                                                                                                                             
            // // get the Model reference                                                                                                                                                                                                                      
            // var oModel = this.getView().getModel();                                                                                                                                                                                                         
            // let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                  
            // return new Promise((resolve, reject) => {                                                                                                                                                                                                       
            //     // Perform Read operation and pass billingdoc as parameter to URL                                                                                                                                                                           
            //     oModel.read("/ZC_MM_ARVORE_MERCADORIA", {                                                                                                                                                                                                   
            //         filters: oFilter,                                                                                                                                                                                                                       
            //         success: function (oData, oResponse) {                                                                                                                                                                                                  
            //             resolve(oData);                                                                                                                                                                                                                     
            //         },                                                                                                                                                                                                                                      
            //         error: function (oError) {                                                                                                                                                                                                              
            //             reject(oError);                                                                                                                                                                                                                     
            //         }                                                                                                                                                                                                                                       
            //     });                                                                                                                                                                                                                                         
            // })                                                                                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        handleTypeMissmatch: function (oEvent) {                                                                                                                                                                                                               
            var aFileTypes = oEvent.getSource().getFileType();                                                                                                                                                                                                 
            jQuery.each(aFileTypes, function (key, value) { aFileTypes[key] = "*." + value; });                                                                                                                                                                
            var sSupportedFileTypes = aFileTypes.join(", ");                                                                                                                                                                                                   
            sap.m.MessageToast.show("Tipo de arquivo *." + oEvent.getParameter("fileType") +                                                                                                                                                                   
                " nao ? suportado. Escolha um dos tipos a seguir: " +                                                                                                                                                                                          
                sSupportedFileTypes);                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        setData: function () {                                                                                                                                                                                                                                 
            let oFilter = this.getView().byId("listReportFilter").getFilters();                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            // get the Model reference                                                                                                                                                                                                                         
            var oModel = this.getView().getModel();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            let oCtx = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                                     
            return new Promise((resolve, reject) => {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                // Perform Read operation and pass billingdoc as parameter to URL                                                                                                                                                                              
                oModel.read("/ZC_MM_ARVORE_MERCADORIA", {                                                                                                                                                                                                      
                    filters: oFilter,                                                                                                                                                                                                                          
                    success: function (oData, oResponse) {                                                                                                                                                                                                     
                        resolve(oData);                                                                                                                                                                                                                        
                    },                                                                                                                                                                                                                                         
                    error: function (oError) {                                                                                                                                                                                                                 
                        reject(oError);                                                                                                                                                                                                                        
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
    };                                                                                                                                                                                                                                                         
});                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               